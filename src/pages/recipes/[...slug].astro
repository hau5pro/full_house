---
import { getCollection, render } from "astro:content";
import { CDN_BASE } from "../../config";
import { UNCATEGORIZED } from "../../infrastructure/constants";
import BaseLayout from "../../layouts/base-layout.astro";
import TagChips from "../../components/TagChips.astro";
import NutritionCard from "../../components/NutritionCard.astro";
import "../../styles/recipe.css";

export async function getStaticPaths() {
  const posts = await getCollection("recipes");
  return posts.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const imageUrl = `${CDN_BASE}/${entry.data.image}`;
const { Content } = await render(entry);

const category = entry.id.includes("/")
  ? entry.id.split("/")[0]
  : UNCATEGORIZED;
---

<BaseLayout title={`${entry.data.title} | Full House`} description={entry.data.description}>
  <div class="container-narrow" data-pagefind-body>
    <nav class="breadcrumb" data-pagefind-ignore>
      <a href="/">Recipes</a>
      <span>/</span>
      <span class="breadcrumb-category">{category}</span>
    </nav>
    <header class="recipe-header">
      <h1>{entry.data.title}</h1>
      {
        entry.data.description && (
          <p class="recipe-description" data-pagefind-weight="3">{entry.data.description}</p>
        )
      }
      {
        entry.data.meta && (
          <div class="recipe-meta" data-pagefind-ignore>
            {
              entry.data.meta.servings && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Servings</span>
                  <span class="meta-value">{entry.data.meta.servings}</span>
                </div>
              )
            }
            {
              entry.data.meta.prepTime && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Prep Time</span>
                  <span class="meta-value">{entry.data.meta.prepTime}</span>
                </div>
              )
            }
            {
              entry.data.meta.cookTime && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Cook Time</span>
                  <span class="meta-value">{entry.data.meta.cookTime}</span>
                </div>
              )
            }
          </div>
        )
      }
      <div data-pagefind-weight="5">
        <TagChips tags={entry.data.tags} linked />
      </div>
      {
        entry.data.image && (
          <img src={imageUrl} alt={entry.data.title} class="recipe-img" data-pagefind-meta="image[src]" />
        )
      }
    </header>

    <article class="prose">
      <Content />
    </article>

    {entry.data.nutrition && <div data-pagefind-ignore><NutritionCard {...entry.data.nutrition} /></div>}
  </div>
</BaseLayout>
