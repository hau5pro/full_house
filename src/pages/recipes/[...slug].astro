---
import { getCollection, render } from "astro:content";
import { CDN_BASE } from "../../config";
import { UNCATEGORIZED } from "../../infrastructure/constants";
import BaseLayout from "../../layouts/base-layout.astro";
import TagChips from "../../components/TagChips.astro";
import "../../styles/recipe.css";

export async function getStaticPaths() {
  const posts = await getCollection("recipes");
  return posts.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const imageUrl = `${CDN_BASE}/${entry.data.image}`;
const { Content } = await render(entry);

const category = entry.id.includes("/")
  ? entry.id.split("/")[0]
  : UNCATEGORIZED;
---

<BaseLayout title={`${entry.data.title} | Full House`} description={entry.data.description}>
  <div class="container-narrow">
    <nav class="breadcrumb">
      <a href="/">Recipes</a>
      <span>/</span>
      <span class="breadcrumb-category">{category}</span>
    </nav>
    <header class="recipe-header">
      <h1>{entry.data.title}</h1>
      {
        entry.data.description && (
          <p class="recipe-description">{entry.data.description}</p>
        )
      }
      {
        entry.data.meta && (
          <div class="recipe-meta">
            {
              entry.data.meta.servings && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Servings</span>
                  <span class="meta-value">{entry.data.meta.servings}</span>
                </div>
              )
            }
            {
              entry.data.meta.prepTime && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Prep Time</span>
                  <span class="meta-value">{entry.data.meta.prepTime}</span>
                </div>
              )
            }
            {
              entry.data.meta.cookTime && (
                <div class="recipe-meta-item">
                  <span class="meta-label">Cook Time</span>
                  <span class="meta-value">{entry.data.meta.cookTime}</span>
                </div>
              )
            }
          </div>
        )
      }
      <TagChips tags={entry.data.tags} />
      {
        entry.data.image && (
          <img src={imageUrl} alt={entry.data.title} class="recipe-img" />
        )
      }
    </header>

    <article class="prose">
      <Content />
    </article>

    {
      entry.data.nutrition && (
        <div class="nutrition-card">
          <div class="nutrition-header">Nutrition Facts</div>
          <div class="nutrition-row nutrition-serving">
            <span>Serving size</span>
            <span class="nutrition-serving-value">{entry.data.nutrition.servingSize}</span>
          </div>
          <div class="nutrition-divider-thick" />
          <div class="nutrition-row nutrition-calories">
            <span>Calories</span>
            <span class="calories-value">{entry.data.nutrition.calories}</span>
          </div>
          <div class="nutrition-divider" />
          <div class="nutrition-row">
            <span>Total Fat</span>
            <span>{entry.data.nutrition.fat}</span>
          </div>
          <div class="nutrition-divider" />
          <div class="nutrition-row">
            <span>Total Carbs</span>
            <span>{entry.data.nutrition.carbs}</span>
          </div>
          <div class="nutrition-divider" />
          <div class="nutrition-row">
            <span>Protein</span>
            <span>{entry.data.nutrition.protein}</span>
          </div>
        </div>
      )
    }
  </div>
</BaseLayout>
