---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from "../layouts/base-layout.astro";
import "./index.css";
import { CDN_BASE } from "../config";
import { UNCATEGORIZED } from "../infrastructure/constants";
import TagChips from "../components/TagChips.astro";

const allRecipes = await getCollection("recipes");

const groupedRecipes = allRecipes.reduce(
  (acc: Record<string, CollectionEntry<"recipes">[]>, recipe) => {
    const category = recipe.id.includes("/")
      ? recipe.id.split("/")[0]
      : UNCATEGORIZED;

    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(recipe);
    return acc;
  },
  {},
);

const categories = Object.keys(groupedRecipes).sort();
---

<BaseLayout title="Full House - Cookbook">
  <div class="container">
    <div class="hero-section">
      <img
        src={`${CDN_BASE}/opt-default.webp`}
        alt="full house"
        class="hero-image"
      />
      <h1 class="hero-title">Can you smell what the rock is cooking?</h1>
    </div>

    {
      categories.map((category) => (
        <section class="category-section">
          <h2 class="category-header">{category}</h2>
          <ul class="recipe-grid">
            {groupedRecipes[category].map((recipe) => (
              <li>
                <a href={`/recipes/${recipe.id}`} class="recipe-card-link">
                  <article class="recipe-card">
                    {recipe.data.image && (
                      <img
                        src={`${CDN_BASE}/${recipe.data.image}`}
                        alt={recipe.data.title}
                        class="recipe-card-image"
                      />
                    )}
                    <div class="recipe-card-content">
                      <h3 class="recipe-card-title">{recipe.data.title}</h3>
                      {recipe.data.description && (
                        <p class="recipe-card-description">
                          {recipe.data.description}
                        </p>
                      )}
                      <TagChips tags={recipe.data.tags} limit={3} />
                      {recipe.data.meta && (recipe.data.meta.prepTime || recipe.data.meta.cookTime) && (
                        <div class="recipe-card-meta">
                          {recipe.data.meta.prepTime && (
                            <span class="meta-item">
                              Prep: {recipe.data.meta.prepTime}
                            </span>
                          )}
                          {recipe.data.meta.cookTime && (
                            <span class="meta-item">
                              Cook: {recipe.data.meta.cookTime}
                            </span>
                          )}
                        </div>
                      )}
                    </div>
                  </article>
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))
    }
  </div>
</BaseLayout>
