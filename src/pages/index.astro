---
import { type CollectionEntry, getCollection } from "astro:content";
import BaseLayout from "../layouts/base-layout.astro";
import "./index.css";
import "../styles/recipe-grid.css";
import { UNCATEGORIZED } from "../infrastructure/constants";
import RecipeCard from "../components/RecipeCard.astro";

const allRecipes = await getCollection("recipes");

const groupedRecipes = allRecipes.reduce(
  (acc: Record<string, CollectionEntry<"recipes">[]>, recipe) => {
    const category = recipe.id.includes("/")
      ? recipe.id.split("/")[0]
      : UNCATEGORIZED;

    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(recipe);
    return acc;
  },
  {},
);

const categories = Object.keys(groupedRecipes).sort();
---

<BaseLayout title="Full House - Cookbook">
  <div class="container">
    <p class="hero-subtitle">Can you smell what the rock is cooking?</p>

    <div class="content-layout">
      <nav class="category-nav" aria-label="Category navigation">
        {categories.map((category) => (
          <a href={`#${category}`} class="category-nav-link">{category}</a>
        ))}
      </nav>

      <div class="category-content">
        {
          categories.map((category) => (
            <section id={category} class="category-section">
              <h2 class="category-header">{category}</h2>
              <ul class="recipe-grid">
                {groupedRecipes[category].map((recipe) => (
                  <li>
                    <RecipeCard recipe={recipe} />
                  </li>
                ))}
              </ul>
            </section>
          ))
        }
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const categoryNav = document.querySelector<HTMLElement>('.category-nav');
  const sections = document.querySelectorAll<HTMLElement>('.category-section');
  const navLinks = document.querySelectorAll<HTMLAnchorElement>('.category-nav-link');

  const observer = new IntersectionObserver(
    (entries) => {
      for (const entry of entries) {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          navLinks.forEach((link) => {
            link.classList.toggle('active', link.getAttribute('href') === `#${id}`);
          });

          // On mobile, scroll active pill into view
          const active = categoryNav?.querySelector('.active');
          if (active && categoryNav) {
            active.scrollIntoView({ inline: 'center', block: 'nearest', behavior: 'smooth' });
          }
        }
      }
    },
    { rootMargin: '-20% 0px -60% 0px' }
  );

  sections.forEach((section) => observer.observe(section));
</script>
